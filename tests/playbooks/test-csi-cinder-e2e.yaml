- hosts: all
  become: true
  become_method: sudo
  gather_facts: true

  vars:
    user: stack
    github_pr: 123
    global_env: {}
    devstack_workdir: /home/{{ user }}/devstack
    cpo_src_dir: "{{ ansible_user_dir }}/src/k8s.io/cloud-provider-openstack"


  roles:
    - role: install-golang
    - role: install-devstack
      enable_services:
        - nova
        - neutron
        - glance
        - cinder
    - role: install-k3s
      worker_node_count: 0
      k8s_branch: release-1.22
    - role: install-docker
    - role: install-docker-registry
      cert_hosts: ' ["{{ ansible_default_ipv4.address }}"]'
    - role: install-csi-cinder
      environment: "{{ global_env }}"

  tasks:
    - name: Run functional tests for csi-cinder-plugin
      environment: "{{ global_env }}"
      shell:
        executable: /bin/bash
        chdir: '{{ cpo_src_dir }}'
        cmd: |
          set -ex
          set -o pipefail
          go test -v ./cmd/tests/cinder-csi-e2e-suite/cinder_csi_e2e_suite_test.go -ginkgo.v -ginkgo.progress -ginkgo.skip="\[Disruptive\]" -ginkgo.focus="\[cinder-csi-e2e\]" -ginkgo.noColor -timeout=0
